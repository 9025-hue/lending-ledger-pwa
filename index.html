<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ’°</text></svg>" type="image/svg+xml" />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lending Ledger</title>

  <meta name="theme-color" content="#1f2937">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Lending Ledger">
  <meta name="description" content="Track your loans and manage your lending business">

  <!-- Link to the Web App Manifest -->
  <link rel="manifest" href="/manifest.json">

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    /* Install prompt styles */
    .install-prompt {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #1f2937;
      color: white;
      padding: 12px 24px;
      border-radius: 25px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 1000;
      display: none;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from { transform: translateX(-50%) translateY(100px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }

    .install-prompt button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 15px;
      margin-left: 12px;
      cursor: pointer;
      font-weight: 600;
    }

    .install-prompt button:hover {
      background: #2563eb;
    }

    .install-prompt .close-btn {
      background: transparent;
      color: #9ca3af;
      padding: 4px 8px;
      margin-left: 8px;
    }

    .install-prompt .close-btn:hover {
      color: white;
      background: rgba(255,255,255,0.1);
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <div id="install-prompt" class="install-prompt">
    <span>ðŸ“± Install Lending Ledger for easy access</span>
    <button id="install-btn">Install</button>
    <button id="dismiss-btn" class="close-btn">âœ•</button>
  </div>

  <nav id="navbar" class="bg-gray-800 p-4 shadow-lg rounded-b-lg hidden">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-white text-2xl font-bold">ðŸ’° Lending Ledger</h1>
      <div class="flex space-x-4" id="navbar-links">
        <button onclick="changeView('dashboard')" class="px-4 py-2 rounded-lg transition-colors text-gray-300 hover:bg-gray-700 hover:text-white">Dashboard</button>
        <button onclick="changeView('clients')" class="px-4 py-2 rounded-lg transition-colors text-gray-300 hover:bg-gray-700 hover:text-white">Clients</button>
        <button onclick="changeView('payable')" class="px-4 py-2 rounded-lg transition-colors text-gray-300 hover:bg-gray-700 hover:text-white">Accounts Payable</button>
        <button onclick="signOutUser()" class="px-4 py-2 rounded-lg transition-colors text-gray-300 hover:bg-gray-700 hover:text-white">Sign Out</button>
      </div>
    </div>
  </nav>

  <div id="login-page" class="flex-grow flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
      <div class="flex space-x-2 justify-center mb-6">
        <button id="login-tab" onclick="setAuthMode('login')" class="px-6 py-2 rounded-lg text-gray-500 hover:bg-gray-200 font-semibold transition-all">Log In</button>
        <button id="register-tab" onclick="setAuthMode('register')" class="px-6 py-2 rounded-lg bg-indigo-600 text-white font-semibold transition-all">Register</button>
      </div>

      <h2 class="text-3xl font-bold text-gray-800 mb-6" id="auth-title">Register for Lending Ledger</h2>
      <p class="text-gray-600 mb-6" id="auth-message">Create an account with your email and password.</p>

      <form id="email-auth-form" class="space-y-4">
        <input type="text" id="display-name-input" placeholder="Your Name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        <input type="email" id="email-input" placeholder="Email Address" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        <input type="password" id="password-input" placeholder="Password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>

        <div id="forgot-password-link" class="flex justify-end text-sm hidden">
          <button type="button" onclick="handleForgotPassword()" class="text-indigo-600 hover:underline transition-colors font-semibold">Forgot Password?</button>
        </div>

        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 transition-colors" id="email-auth-button">
          Register
        </button>
      </form>

      <div id="auth-error-message" class="text-red-500 mt-4 text-sm hidden"></div>
    </div>
  </div>

  <main id="main-content" class="container mx-auto p-4 hidden">
    <div id="app-container"></div>
  </main>

  <div id="init-error" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full text-center">
      <h3 class="text-2xl font-bold text-red-600 mb-4">Application Error</h3>
      <p id="init-error-message" class="text-gray-700 mb-6">An unknown error occurred during initialization. Please try again later.</p>
      <button onclick="closeModal('init-error')" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors">Close</button>
    </div>
  </div>

  <div id="loan-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
      <div class="flex justify-between items-center mb-4">
        <h3 id="modal-title" class="text-2xl font-bold text-gray-800">Add New Loan</h3>
        <button onclick="closeModal('loan-modal')" class="text-gray-500 hover:text-gray-800 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
      <form id="loan-form">
        <input type="hidden" id="transaction-id">
        <div class="mb-4">
          <label for="borrower-name" class="block text-gray-700 font-medium mb-2">Client Name</label>
          <input type="text" id="borrower-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        <div class="mb-4">
          <label for="amount" class="block text-gray-700 font-medium mb-2">Original Amount (R)</label>
          <input type="number" id="amount" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" step="0.01" required>
        </div>
        <div class="mb-4" id="interest-rate-group">
          <label for="interest-rate" class="block text-gray-700 font-medium mb-2">Monthly Interest Rate (%)</label>
          <input type="number" id="interest-rate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" min="0" step="0.1">
        </div>
        <div class="mb-4" id="loan-period-group">
          <label for="loan-period" class="block text-gray-700 font-medium mb-2">Loan Period (Months)</label>
          <input type="number" id="loan-period" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" min="1">
        </div>
        <div class="mb-6">
          <label for="due-date" class="block text-gray-700 font-medium mb-2">Due Date</label>
          <input type="date" id="due-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        <div class="flex justify-end space-x-4">
          <button type="button" onclick="closeModal('loan-modal')" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancel</button>
          <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">Submit</button>
        </div>
      </form>
    </div>
  </div>

  <div id="payment-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-2xl font-bold text-gray-800">Record Payment</h3>
        <button onclick="closeModal('payment-modal')" class="text-gray-500 hover:text-gray-800 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <div class="mb-4 p-4 bg-gray-50 rounded-lg">
        <p class="text-gray-700">Client: <span class="font-semibold" id="payment-client-name"></span></p>
        <p class="text-gray-700 mt-2">Current Balance: <span class="font-semibold text-xl text-green-600" id="payment-current-balance"></span></p>
        <p class="text-gray-700 mt-2">Last Payment: <span class="font-medium" id="payment-last-payment"></span></p>
      </div>

      <form id="payment-form">
        <input type="hidden" id="payment-transaction-id">
        <div class="mb-4">
          <label for="payment-amount" class="block text-gray-700 font-medium mb-2">Payment Amount (R)</label>
          <input type="number" id="payment-amount" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" step="0.01" min="0.01" required>
        </div>
        <div class="mb-4">
          <label for="payment-date" class="block text-gray-700 font-medium mb-2">Payment Date</label>
          <input type="date" id="payment-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        <div class="mb-4">
          <label for="payment-method" class="block text-gray-700 font-medium mb-2">Payment Method</label>
          <select id="payment-method" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="cash">Cash</option>
            <option value="bank_transfer">Bank Transfer</option>
            <option value="mobile_money">Mobile Money</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="mb-4">
          <label for="payment-notes" class="block text-gray-700 font-medium mb-2">Notes (Optional)</label>
          <textarea id="payment-notes" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="2"></textarea>
        </div>
        <div class="flex justify-end space-x-4">
          <button type="button" onclick="closeModal('payment-modal')" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancel</button>
          <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">Record Payment</button>
        </div>
      </form>
    </div>
  </div>

  <div id="message-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full text-center">
      <h3 id="message-modal-title" class="text-xl font-bold mb-4"></h3>
      <p id="message-modal-content" class="text-gray-700 mb-6"></p>
      <button onclick="closeModal('message-modal')" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">OK</button>
    </div>
  </div>

  <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full text-center">
      <h3 id="confirm-modal-title" class="text-xl font-bold mb-4">Confirm Action</h3>
      <p id="confirm-modal-content" class="text-gray-700 mb-6">Are you sure you want to proceed?</p>
      <div class="flex justify-center space-x-4">
        <button id="confirm-cancel-btn" onclick="closeModal('confirm-modal')" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancel</button>
        <button id="confirm-ok-btn" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors">Confirm</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
        getAuth,
        onAuthStateChanged,
        signOut,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        sendPasswordResetEmail,
        updateProfile,
        signInWithCustomToken
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      onSnapshot,
      doc,
      setDoc,
      addDoc,
      updateDoc,
      deleteDoc,
      serverTimestamp,
      getDoc,
      getDocs,
      query,
      where,
      writeBatch // Import writeBatch for atomic operations
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global state management
    const state = {
      db: null,
      auth: null,
      userId: null,
      displayName: null,
      isAuthReady: false,
      receivables: [],
      payables: [],
      clients: [], // Clients derived from receivables
      activeView: 'dashboard', // Default to dashboard
      currentClientName: null,
      isRegisterMode: true,
      appId: null, // Add appId to state
    };

    // Firebase configuration and initialization
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
      apiKey: "AIzaSyArljsBjgdSiZxKYQnAYMSx93C8H6jBy0Y",
      authDomain: "loan-lending-772ad.firebaseapp.com",
      projectId: "loan-lending-772ad",
      storageBucket: "loan-lending-772ad.firebasestorage.app",
      messagingSenderId: "308404853120",
      appId: "1:308404853120:web:18b3a4ab1189e9cb8a0965",
      measurementId: "G-1NS69YRCF0"
    };

    const app = initializeApp(firebaseConfig);
    state.db = getFirestore(app);
    state.auth = getAuth(app);
    state.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Initialize appId here

    // Expose Firebase Firestore functions globally for inline event handlers
    window.firebaseFirestore = {
        doc,
        collection,
        getDoc,
        getDocs,
        query,
        where,
        updateDoc,
        addDoc,
        deleteDoc,
        writeBatch,
        serverTimestamp
    };

    // Function to calculate current balance.
    const calculateCurrentBalance = (transaction) => {
      if (transaction.isPaid) {
        return 0;
      }
      if (transaction.currentBalance !== undefined && transaction.currentBalance !== null) {
        return transaction.currentBalance;
      }
      if (!transaction.createdAt) {
        return transaction.amount || 0;
      }
      
      const now = new Date();
      const createdAtDate = transaction.createdAt.toDate ? transaction.createdAt.toDate() : new Date(transaction.createdAt.seconds * 1000);
      const monthsElapsed = (now.getFullYear() - createdAtDate.getFullYear()) * 12 + (now.getMonth() - createdAtDate.getMonth());
      const monthlyInterestRate = (transaction.interestRate || 0) / 100;
      const initialAmount = transaction.originalAmount || transaction.amount || 0;
      
      return initialAmount * Math.pow(1 + monthlyInterestRate, monthsElapsed);
    };

    // Function to format date
    const formatDate = (date) => {
      if (!date) return 'N/A';
      const d = date.toDate ? date.toDate() : new Date(date);
      return d.toLocaleDateString('en-ZA', { year: 'numeric', month: 'short', day: 'numeric' });
    };

    // Custom message modal
    window.showMessage = (title, message) => {
      document.getElementById('message-modal-title').textContent = title;
      document.getElementById('message-modal-content').textContent = message;
      openModal('message-modal');
    };

    // Custom confirmation modal
    window.showConfirm = (title, message, onConfirm) => {
      document.getElementById('confirm-modal-title').textContent = title;
      document.getElementById('confirm-modal-content').textContent = message;
      const confirmBtn = document.getElementById('confirm-ok-btn');
      const cancelBtn = document.getElementById('confirm-cancel-btn');

      const handleConfirm = () => {
        onConfirm();
        confirmBtn.removeEventListener('click', handleConfirm);
        cancelBtn.removeEventListener('click', handleCancel);
        closeModal('confirm-modal');
      };

      const handleCancel = () => {
        confirmBtn.removeEventListener('click', handleConfirm);
        cancelBtn.removeEventListener('click', handleCancel);
        closeModal('confirm-modal');
      };

      confirmBtn.addEventListener('click', handleConfirm);
      cancelBtn.addEventListener('click', handleCancel);
      openModal('confirm-modal');
    };

    // PDF Generation Functions
    window.downloadClientReport = async (clientName) => {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Title
        doc.setFontSize(20);
        doc.text(`Client Report: ${clientName}`, 14, 22);
        
        // Date
        doc.setFontSize(12);
        doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 32);

        const clientLoans = state.receivables.filter(loan => loan.borrowerName === clientName);
        const totalLoanAmount = clientLoans.reduce((sum, loan) => sum + (loan.originalAmount || loan.amount || 0), 0);
        const totalOutstandingBalance = clientLoans.reduce((sum, loan) => sum + (loan.isPaid ? 0 : calculateCurrentBalance(loan)), 0);
        const totalPaid = clientLoans.reduce((sum, loan) => sum + (loan.totalPaidAmount || 0), 0);

        // Summary
        doc.setFontSize(14);
        doc.text('Summary:', 14, 50);
        doc.setFontSize(12);
        doc.text(`Total Loaned: R${totalLoanAmount.toFixed(2)}`, 14, 60);
        doc.text(`Total Outstanding: R${totalOutstandingBalance.toFixed(2)}`, 14, 70);
        doc.text(`Total Paid: R${totalPaid.toFixed(2)}`, 14, 80);

        // Loans table
        const tableData = clientLoans.map(loan => [
          formatDate(loan.createdAt),
          `R${(loan.originalAmount || loan.amount || 0).toFixed(2)}`,
          `R${(loan.isPaid ? 0 : calculateCurrentBalance(loan)).toFixed(2)}`,
          `${((loan.interestRate || 0) * 100).toFixed(1)}%`,
          loan.isPaid ? 'Paid' : 'Unpaid'
        ]);

        doc.autoTable({
          head: [['Date', 'Original Amount', 'Current Balance', 'Interest Rate', 'Status']],
          body: tableData,
          startY: 90,
          styles: { fontSize: 10 },
          headStyles: { fillColor: [59, 130, 246] }
        });

        // Payment History
        const paymentsQuery = query(
          collection(state.db, `artifacts/${state.appId}/users/${state.userId}/payments`),
          where('clientName', '==', clientName)
        );

        const querySnapshot = await getDocs(paymentsQuery);
        const payments = querySnapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));

        if (payments.length > 0) {
          payments.sort((a, b) => {
            const dateA = a.date.toDate ? a.date.toDate() : new Date(a.date.seconds * 1000);
            const dateB = b.date.toDate ? b.date.toDate() : new Date(b.date.seconds * 1000);
            return dateB - dateA;
          });

          const paymentTableData = payments.map(payment => [
            formatDate(payment.date),
            `R${payment.amount.toFixed(2)}`,
            payment.method.replace('_', ' ').toUpperCase(),
            payment.notes || '-'
          ]);

          const finalY = doc.lastAutoTable.finalY || 90;
          doc.setFontSize(14);
          doc.text('Payment History:', 14, finalY + 20);

          doc.autoTable({
            head: [['Date', 'Amount', 'Method', 'Notes']],
            body: paymentTableData,
            startY: finalY + 30,
            styles: { fontSize: 10 },
            headStyles: { fillColor: [34, 197, 94] }
          });
        }

        doc.save(`${clientName}_Report.pdf`);
        showMessage('Success', 'PDF report downloaded successfully!');
      } catch (error) {
        console.error('Error generating PDF:', error);
        showMessage('Error', 'Failed to generate PDF report.');
      }
    };

    window.downloadAllReports = async () => {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Title
        doc.setFontSize(20);
        doc.text('All Clients Report', 14, 22);
        
        // Date
        doc.setFontSize(12);
        doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 32);

        // Overall Summary
        const totalReceivable = state.receivables.filter(t => !t.isPaid).reduce((sum, t) => sum + calculateCurrentBalance(t), 0);
        const totalLoanAmount = state.receivables.reduce((sum, t) => sum + (t.originalAmount || t.amount || 0), 0);
        const totalPaid = state.receivables.reduce((sum, t) => sum + (t.totalPaidAmount || 0), 0);

        doc.setFontSize(14);
        doc.text('Overall Summary:', 14, 50);
        doc.setFontSize(12);
        doc.text(`Total Loaned: R${totalLoanAmount.toFixed(2)}`, 14, 60);
        doc.text(`Total Outstanding: R${totalReceivable.toFixed(2)}`, 14, 70);
        doc.text(`Total Paid: R${totalPaid.toFixed(2)}`, 14, 80);

        // Client summary table
        const clientSummaryData = state.clients.map(client => {
          const clientLoans = state.receivables.filter(loan => loan.borrowerName === client.name);
          const clientTotal = clientLoans.reduce((sum, loan) => sum + (loan.originalAmount || loan.amount || 0), 0);
          const clientOutstanding = clientLoans.reduce((sum, loan) => sum + (loan.isPaid ? 0 : calculateCurrentBalance(loan)), 0);
          const clientPaid = clientLoans.reduce((sum, loan) => sum + (loan.totalPaidAmount || 0), 0);

          return [
            client.name,
            `R${clientTotal.toFixed(2)}`,
            `R${clientOutstanding.toFixed(2)}`,
            `R${clientPaid.toFixed(2)}`,
            clientLoans.length.toString()
          ];
        });

        doc.autoTable({
          head: [['Client', 'Total Loaned', 'Outstanding', 'Paid', 'Loans Count']],
          body: clientSummaryData,
          startY: 90,
          styles: { fontSize: 10 },
          headStyles: { fillColor: [59, 130, 246] }
        });

        doc.save('All_Clients_Report.pdf');
        showMessage('Success', 'All clients PDF report downloaded successfully!');
      } catch (error) {
        console.error('Error generating all clients PDF:', error);
        showMessage('Error', 'Failed to generate all clients PDF report.');
      }
    };

    window.generatePaymentReceipt = async (paymentId) => {
      try {
        const { jsPDF } = window.jspdf;
        
        // Get payment data
        const paymentDoc = await getDoc(doc(state.db, `artifacts/${state.appId}/users/${state.userId}/payments`, paymentId));
        if (!paymentDoc.exists()) {
          showMessage('Error', 'Payment not found.');
          return;
        }

        const payment = paymentDoc.data();
        const doc_pdf = new jsPDF();

        // Title
        doc_pdf.setFontSize(20);
        doc_pdf.text('Payment Receipt', 14, 22);
        
        // Receipt details
        doc_pdf.setFontSize(12);
        doc_pdf.text(`Receipt ID: ${paymentId}`, 14, 40);
        doc_pdf.text(`Date: ${formatDate(payment.date)}`, 14, 50);
        doc_pdf.text(`Client: ${payment.clientName}`, 14, 60);
        doc_pdf.text(`Amount: R${payment.amount.toFixed(2)}`, 14, 70);
        doc_pdf.text(`Payment Method: ${payment.method.replace('_', ' ').toUpperCase()}`, 14, 80);
        
        if (payment.notes) {
          doc_pdf.text(`Notes: ${payment.notes}`, 14, 90);
        }

        // Footer
        doc_pdf.text('Thank you for your payment!', 14, 120);
        doc_pdf.text(`Generated by: ${state.displayName || 'Lending Ledger'}`, 14, 130);

        doc_pdf.save(`Payment_Receipt_${paymentId}.pdf`);
        showMessage('Success', 'Payment receipt downloaded successfully!');
      } catch (error) {
        console.error('Error generating payment receipt:', error);
        showMessage('Error', 'Failed to generate payment receipt.');
      }
    };

    // Delete functions
    window.deleteTransaction = (transactionId, type) => {
      const isReceivable = type === 'receivable';
      const confirmMessage = `Are you sure you want to delete this ${isReceivable ? 'loan' : 'payable'}? This action cannot be undone.`;
      
      showConfirm('Delete Transaction', confirmMessage, async () => {
        try {
          const collectionPath = `artifacts/${state.appId}/users/${state.userId}/${isReceivable ? 'receivables' : 'payables'}`;
          await deleteDoc(doc(state.db, collectionPath, transactionId));
          
          // Also delete related payments if it's a receivable
          if (isReceivable) {
            const paymentsQuery = query(
              collection(state.db, `artifacts/${state.appId}/users/${state.userId}/payments`),
              where('transactionId', '==', transactionId)
            );
            const paymentSnapshot = await getDocs(paymentsQuery);
            const batch = writeBatch(state.db);
            
            paymentSnapshot.docs.forEach(paymentDoc => {
              batch.delete(paymentDoc.ref);
            });
            
            if (paymentSnapshot.docs.length > 0) {
              await batch.commit();
            }
          }
          
          showMessage('Success', `${isReceivable ? 'Loan' : 'Payable'} deleted successfully.`);
        } catch (error) {
          console.error('Error deleting transaction:', error);
          showMessage('Error', `Failed to delete ${isReceivable ? 'loan' : 'payable'}.`);
        }
      });
    };

    window.deleteClientConfirm = (clientName) => {
      const clientLoans = state.receivables.filter(loan => loan.borrowerName === clientName);
      const confirmMessage = `Are you sure you want to delete client "${clientName}" and all ${clientLoans.length} associated loan(s) and payment(s)? This action cannot be undone.`;
      
      showConfirm('Delete Client', confirmMessage, async () => {
        try {
          const batch = writeBatch(state.db);
          
          // Delete all loans for this client
          clientLoans.forEach(loan => {
            const loanRef = doc(state.db, `artifacts/${state.appId}/users/${state.userId}/receivables`, loan.id);
            batch.delete(loanRef);
          });
          
          // Delete all payments for this client
          const paymentsQuery = query(
            collection(state.db, `artifacts/${state.appId}/users/${state.userId}/payments`),
            where('clientName', '==', clientName)
          );
          const paymentSnapshot = await getDocs(paymentsQuery);
          paymentSnapshot.docs.forEach(paymentDoc => {
            batch.delete(paymentDoc.ref);
          });
          
          await batch.commit();
          showMessage('Success', `Client "${clientName}" and all associated data deleted successfully.`);
          
          // Navigate back to clients view
          changeView('clients');
        } catch (error) {
          console.error('Error deleting client:', error);
          showMessage('Error', `Failed to delete client "${clientName}".`);
        }
      });
    };
