<!DOCTYPE html>
<html lang="en">
<head>
  <head>
  <!-- ... existing meta tags and links ... -->
  <link rel="manifest" href="/manifest.json">
  <!-- ... rest of your head content ... -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ’°</text></svg>" type="image/svg+xml" />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lending Ledger</title>

  <meta name="theme-color" content="#1f2937">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Lending Ledger">
  <meta name="description" content="Track your loans and manage your lending business">

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    /* Install prompt styles */
    .install-prompt {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #1f2937;
      color: white;
      padding: 12px 24px;
      border-radius: 25px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 1000;
      display: none;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from { transform: translateX(-50%) translateY(100px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }

    .install-prompt button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 15px;
      margin-left: 12px;
      cursor: pointer;
      font-weight: 600;
    }

    .install-prompt button:hover {
      background: #2563eb;
    }

    .install-prompt .close-btn {
      background: transparent;
      color: #9ca3af;
      padding: 4px 8px;
      margin-left: 8px;
    }

    .install-prompt .close-btn:hover {
      color: white;
      background: rgba(255,255,255,0.1);
    }

    /* PDF loading indicator */
    .pdf-loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .pdf-loading-content {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      text-align: center;
    }
    .pdf-loading-spinner {
      border: 4px solid rgba(0,0,0,0.1);
      border-radius: 50%;
      border-top: 4px solid #3498db;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- PDF Loading Indicator -->
  <div id="pdf-loading" class="pdf-loading hidden">
    <div class="pdf-loading-content">
      <div class="pdf-loading-spinner"></div>
      <p>Preparing PDF document...</p>
    </div>
  </div>

  <div id="install-prompt" class="install-prompt">
    <span>ðŸ“± Install Lending Ledger for easy access</span>
    <button id="install-btn">Install</button>
    <button id="dismiss-btn" class="close-btn">âœ•</button>
  </div>

  <!-- Rest of your HTML remains the same -->
  <nav id="navbar" class="bg-gray-800 p-4 shadow-lg rounded-b-lg hidden">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-white text-2xl font-bold">ðŸ’° Lending Ledger</h1>
      <div class="flex space-x-4" id="navbar-links">
        <button onclick="changeView('dashboard')" class="px-4 py-2 rounded-lg transition-colors text-gray-300 hover:bg-gray-700 hover:text-white">Dashboard</button>
        <button onclick="changeView('clients')" class="px-4 py-2 rounded-lg transition-colors text-gray-300 hover:bg-gray-700 hover:text-white">Clients</button>
        <button onclick="changeView('payable')" class="px-4 py-2 rounded-lg transition-colors text-gray-300 hover:bg-gray-700 hover:text-white">Accounts Payable</button>
        <button onclick="signOutUser()" class="px-4 py-2 rounded-lg transition-colors text-gray-300 hover:bg-gray-700 hover:text-white">Sign Out</button>
      </div>
    </div>
  </nav>

  <!-- Rest of your HTML remains unchanged until the scripts -->
  <!-- ... -->

  <!-- Updated script loading with fallbacks -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" onerror="window.pdfLoadError = true"></script>
  <script src="https://unpkg.com/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.js" onerror="window.autoTableLoadError = true"></script>

  <script>
    // Track PDF library loading status
    window.pdfLibrariesLoaded = false;
    window.pdfLoadError = false;
    window.autoTableLoadError = false;

    // Check if PDF libraries are loaded
    function checkPdfLibraries() {
      if (window.pdfLoadError || window.autoTableLoadError) {
        return false;
      }
      return window.jspdf && window.jspdf.jsPDF && window.jspdf.autoTable;
    }

    // Show PDF loading indicator
    function showPdfLoading() {
      document.getElementById('pdf-loading').classList.remove('hidden');
    }

    // Hide PDF loading indicator
    function hidePdfLoading() {
      document.getElementById('pdf-loading').classList.add('hidden');
    }

    // Retry loading PDF libraries
    function retryPdfLibraries(callback) {
      showPdfLoading();
      
      // Create new script elements
      const jsPDFScript = document.createElement('script');
      jsPDFScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
      jsPDFScript.onload = function() {
        const autoTableScript = document.createElement('script');
        autoTableScript.src = 'https://unpkg.com/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.js';
        autoTableScript.onload = function() {
          window.pdfLibrariesLoaded = checkPdfLibraries();
          hidePdfLoading();
          if (window.pdfLibrariesLoaded && typeof callback === 'function') {
            callback();
          } else {
            showMessage('Error', 'Failed to load PDF libraries after retry. Please check your internet connection.');
          }
        };
        autoTableScript.onerror = function() {
          hidePdfLoading();
          showMessage('Error', 'Failed to load PDF table plugin. Please try again later.');
        };
        document.head.appendChild(autoTableScript);
      };
      jsPDFScript.onerror = function() {
        hidePdfLoading();
        showMessage('Error', 'Failed to load PDF library. Please try again later.');
      };
      document.head.appendChild(jsPDFScript);
    }

    // Initialize PDF libraries check
    document.addEventListener('DOMContentLoaded', function() {
      window.pdfLibrariesLoaded = checkPdfLibraries();
    });

    // Updated PDF generation functions with better error handling
    window.generatePaymentReceipt = async function(paymentId) {
      if (!window.pdfLibrariesLoaded) {
        showMessage('Loading PDF Libraries', 'Preparing PDF functionality. Please wait...');
        retryPdfLibraries(function() {
          generatePaymentReceipt(paymentId);
        });
        return;
      }

      showPdfLoading();
      
      try {
        const paymentDoc = await getDoc(doc(state.db, `users/${state.userId}/payments`, paymentId));
        if (!paymentDoc.exists()) {
          hidePdfLoading();
          showMessage('Error', 'Payment not found.');
          return;
        }

        const payment = paymentDoc.data();
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Add receipt content
        doc.setFontSize(18);
        doc.text('PAYMENT RECEIPT', 105, 20, { align: 'center' });

        doc.setFontSize(12);
        doc.text(`Receipt ID: ${paymentDoc.id}`, 20, 40);
        doc.text(`Date: ${formatDate(payment.date)}`, 20, 50);
        doc.text(`Client: ${payment.clientName}`, 20, 60);
        doc.text(`Amount: R${payment.amount.toFixed(2)}`, 20, 70);
        doc.text(`Method: ${payment.method ? payment.method.replace(/_/g, ' ').toUpperCase() : '-'}`, 20, 80);
        doc.text(`Notes: ${payment.notes || '-'}`, 20, 90);

        // Download the PDF
        hidePdfLoading();
        doc.save(`Payment_Receipt_${paymentDoc.id}.pdf`);
      } catch (error) {
        hidePdfLoading();
        console.error("Error generating receipt:", error);
        showMessage('Error', 'Failed to generate receipt. Please try again: ' + error.message);
      }
    };

    // Updated downloadAllReports function
    window.downloadAllReports = async function() {
      if (!window.pdfLibrariesLoaded) {
        showMessage('Loading PDF Libraries', 'Preparing PDF functionality. Please wait...');
        retryPdfLibraries(function() {
          downloadAllReports();
        });
        return;
      }

      showPdfLoading();
      
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(16);
        doc.text('All Client Reports', 14, 20);

        const headers = [['Client Name', 'Loan Date', 'Original Amount (R)', 'Current Balance (R)', 'Interest Rate (%)', 'Status']];
        const data = state.receivables.map(loan => [
          loan.borrowerName,
          formatDate(loan.createdAt),
          (loan.originalAmount || loan.amount || 0).toFixed(2),
          loan.isPaid ? '0.00' : calculateCurrentBalance(loan).toFixed(2),
          ((loan.interestRate || 0) * 100).toFixed(1) + '%',
          loan.isPaid ? 'Paid' : 'Unpaid'
        ]);

        doc.autoTable({
          head: headers,
          body: data,
          startY: 30,
          headStyles: { fillColor: [31, 41, 55] },
          theme: 'striped'
        });

        hidePdfLoading();
        doc.save('All_Client_Reports.pdf');
      } catch (error) {
        hidePdfLoading();
        showMessage('Error', 'Failed to generate reports. Please try again: ' + error.message);
      }
    };

    // Updated downloadClientReport function
    window.downloadClientReport = async function(clientName) {
      if (!window.pdfLibrariesLoaded) {
        showMessage('Loading PDF Libraries', 'Preparing PDF functionality. Please wait...');
        retryPdfLibraries(function() {
          downloadClientReport(clientName);
        });
        return;
      }

      showPdfLoading();
      
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const clientLoans = state.receivables.filter(loan => loan.borrowerName === clientName);
        const totalOutstanding = clientLoans.reduce((sum, loan) => sum + (loan.isPaid ? 0 : calculateCurrentBalance(loan)), 0);

        doc.setFontSize(16);
        doc.text(`Client Report: ${clientName}`, 14, 20);
        doc.setFontSize(12);
        doc.text(`Total Outstanding Balance: R${totalOutstanding.toFixed(2)}`, 14, 30);

        const loanHeaders = [['Loan Date', 'Original Amount (R)', 'Current Balance (R)', 'Interest Rate (%)', 'Status']];
        const loanData = clientLoans.map(loan => [
          formatDate(loan.createdAt),
          (loan.originalAmount || loan.amount || 0).toFixed(2),
          loan.isPaid ? '0.00' : calculateCurrentBalance(loan).toFixed(2),
          ((loan.interestRate || 0) * 100).toFixed(1) + '%',
          loan.isPaid ? 'Paid' : 'Unpaid'
        ]);

        doc.autoTable({
          startY: 40,
          head: loanHeaders,
          body: loanData,
          headStyles: { fillColor: [31, 41, 55] },
          theme: 'striped'
        });

        // Fetch payment history for the client
        let payments = [];
        try {
          const paymentsQuery = query(
            collection(state.db, `users/${state.userId}/payments`),
            where('clientName', '==', clientName)
          );
          const querySnapshot = await getDocs(paymentsQuery);
          payments = querySnapshot.docs.map(docSnap => docSnap.data());
          payments.sort((a, b) => {
            const dateA = a.date.toDate ? a.date.toDate() : new Date(a.date.seconds * 1000);
            const dateB = b.date.toDate ? b.date.toDate() : new Date(b.date.seconds * 1000);
            return dateB - dateA;
          });
        } catch (error) {
          console.error("Error fetching payment history for PDF:", error);
        }

        if (payments.length > 0) {
          let finalY = doc.lastAutoTable.finalY || 40;
          doc.setFontSize(14);
          doc.text(`Payment History`, 14, finalY + 20);
          const paymentHeaders = [['Date', 'Amount (R)', 'Method', 'Notes']];
          const paymentData = payments.map(p => [
            formatDate(p.date),
            p.amount.toFixed(2),
            p.method.replace(/_/g, ' ').toUpperCase(),
            p.notes || '-'
          ]);

          doc.autoTable({
            startY: finalY + 30,
            head: paymentHeaders,
            body: paymentData,
            headStyles: { fillColor: [31, 41, 55] },
            theme: 'striped'
          });
        }
        
        hidePdfLoading();
        doc.save(`Client_Report_${clientName.replace(/\s/g, '_')}.pdf`);
      } catch (error) {
        hidePdfLoading();
        console.error("Error generating client report:", error);
        showMessage('Error', 'Failed to generate client report. Please try again: ' + error.message);
      }
    };

    // Rest of your original script remains the same
    // ... (all the existing Firebase and application logic)
  </script>
</body>
</html>
